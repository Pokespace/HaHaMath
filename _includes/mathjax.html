<!-- å¼•å…¥ MathJax ä»¥æ”¯æŒ LaTeX å…¬å¼æ¸²æŸ“ -->
<script>
  // å¢å¼ºçš„ç§»åŠ¨è®¾å¤‡æ£€æµ‹
  var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  var isAndroid = /Android/.test(navigator.userAgent);
  var isWeChat = /MicroMessenger/i.test(navigator.userAgent);
  
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true,
      processRefs: true,
      packages: {'[+]': ['base', 'ams', 'newcommand', 'configmacros', 'noerrors']}
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      processHtmlClass: 'tex2jax_process',
      ignoreHtmlClass: 'tex2jax_ignore',
      enableMenu: false, // åœ¨ç§»åŠ¨ç«¯ç¦ç”¨å³é”®èœå•
      menuOptions: {
        settings: {
          zoom: 'None'  // ç¦ç”¨ç¼©æ”¾ä»¥é¿å…ç§»åŠ¨ç«¯é—®é¢˜
        }
      }
    },
    // é’ˆå¯¹ä¸åŒè®¾å¤‡çš„æ¸²æŸ“é…ç½®
    chtml: {
      scale: isMobile ? 0.85 : 1,
      minScale: 0.5,
      matchFontHeight: false,
      fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2',
      adaptiveCSS: true,
      // ç§»åŠ¨ç«¯ä¼˜åŒ–
      ...(isMobile && {
        exFactor: 0.5,
        displayAlign: 'center',
        displayIndent: '0'
      })
    },
    svg: {
      scale: isMobile ? 0.85 : 1,
      minScale: 0.5,
      fontCache: 'local',
      // ç§»åŠ¨ç«¯SVGæ¸²æŸ“ä¼˜åŒ–
      ...(isMobile && {
        exFactor: 0.5
      })
    },
    startup: {
      ready: function () {
        MathJax.startup.defaultReady();
        
        // ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†
        if (isMobile) {
          // å»¶è¿Ÿæ¸²æŸ“ä»¥ç¡®ä¿DOMå®Œå…¨åŠ è½½
          setTimeout(function() {
            MathJax.typesetPromise().then(function() {
              console.log('ç§»åŠ¨ç«¯MathJaxæ¸²æŸ“å®Œæˆ');
              // ä¸ºç§»åŠ¨ç«¯æ·»åŠ æ»šåŠ¨ä¼˜åŒ–
              addMobileScrollOptimization();
            }).catch(function(err) {
              console.warn('MathJaxæ¸²æŸ“å‡ºç°é—®é¢˜:', err);
              showMathRenderingFallback();
            });
          }, isMobile ? 500 : 100);
        }
      }
    },
    loader: {
      load: ['[tex]/noerrors']
    }
  };
  
  // ç§»åŠ¨ç«¯æ»šåŠ¨ä¼˜åŒ–
  function addMobileScrollOptimization() {
    if (!isMobile) return;
    
    var style = document.createElement('style');
    style.textContent = `
      mjx-container[display="true"] {
        overflow-x: auto !important;
        overflow-y: hidden !important;
        max-width: 100% !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: thin !important;
      }
      
      mjx-container[display="true"]::-webkit-scrollbar {
        height: 3px !important;
      }
      
      mjx-container[display="true"]::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.3) !important;
        border-radius: 3px !important;
      }
    `;
    document.head.appendChild(style);
  }
  
  // æ¸²æŸ“å¤±è´¥é™çº§å¤„ç†
  function showMathRenderingFallback() {
    var mathElements = document.querySelectorAll('script[type*="math"], .math, [class*="math"]');
    if (mathElements.length > 0) {
      var notice = document.createElement('div');
      notice.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 8px; margin: 10px 0; border-radius: 4px; font-size: 14px; text-align: center;';
      notice.innerHTML = 'ğŸ“± æ•°å­¦å…¬å¼æ­£åœ¨åŠ è½½ä¸­ï¼Œå¦‚æ˜¾ç¤ºå¼‚å¸¸è¯·åˆ·æ–°é¡µé¢...';
      
      var container = document.getElementById('main-content') || document.body;
      container.insertBefore(notice, container.firstChild);
      
      // 3ç§’åç§»é™¤æç¤º
      setTimeout(function() {
        if (notice.parentNode) {
          notice.parentNode.removeChild(notice);
        }
      }, 3000);
    }
  }
</script>

<!-- å¤šCDNåŠ è½½ç­–ç•¥ï¼Œæé«˜ç§»åŠ¨ç«¯åŠ è½½æˆåŠŸç‡ -->
<script>
  (function() {
    var cdnList = [
      'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
      'https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js',
      'https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js'
    ];
    
    var currentCdnIndex = 0;
    
    function loadMathJax() {
      if (currentCdnIndex >= cdnList.length) {
        console.error('æ‰€æœ‰MathJax CDNéƒ½åŠ è½½å¤±è´¥');
        showCdnFailureNotice();
        return;
      }
      
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.id = 'MathJax-script-' + currentCdnIndex;
      script.async = true;
      script.src = cdnList[currentCdnIndex];
      
      script.onload = function() {
        console.log('MathJaxä»CDNåŠ è½½æˆåŠŸ:', cdnList[currentCdnIndex]);
      };
      
      script.onerror = function() {
        console.warn('CDNåŠ è½½å¤±è´¥:', cdnList[currentCdnIndex]);
        document.head.removeChild(script);
        currentCdnIndex++;
        setTimeout(loadMathJax, 1000); // å»¶è¿Ÿ1ç§’åå°è¯•ä¸‹ä¸€ä¸ªCDN
      };
      
      document.head.appendChild(script);
    }
    
    function showCdnFailureNotice() {
      var notice = document.createElement('div');
      notice.style.cssText = 'background: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; margin: 10px 0; border-radius: 5px; color: #721c24; text-align: center;';
      notice.innerHTML = 'âš ï¸ æ•°å­¦å…¬å¼åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢';
      
      var container = document.getElementById('main-content') || document.body;
      container.insertBefore(notice, container.firstChild);
    }
    
    // å¼€å§‹åŠ è½½
    loadMathJax();
  })();
</script>

<!-- ç§»åŠ¨ç«¯ä¸“ç”¨æ ·å¼ä¼˜åŒ– -->
<style>
  /* åŸºç¡€æ ·å¼ */
  mjx-container {
    overflow-x: auto;
    overflow-y: hidden;
  }
  
  /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ */
  @media screen and (max-width: 768px) {
    .MathJax {
      font-size: 0.9em !important;
    }
    
    mjx-container[display="true"] {
      margin: 0.8em 0 !important;
      padding: 0 !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
      max-width: 100% !important;
      -webkit-overflow-scrolling: touch !important;
    }
    
    mjx-container[display="false"] {
      display: inline !important;
      margin: 0 0.1em !important;
    }
  }
  
  /* å°å±å¹•ä¼˜åŒ– */
  @media screen and (max-width: 480px) {
    .MathJax {
      font-size: 0.85em !important;
    }
    
    mjx-container[display="true"] {
      font-size: 0.9em !important;
    }
  }
  
  /* è¶…å°å±å¹• */
  @media screen and (max-width: 320px) {
    .MathJax {
      font-size: 0.8em !important;
    }
  }
  
  /* iOS Safariç‰¹æ®Šå¤„ç† */
  @supports (-webkit-touch-callout: none) {
    mjx-container {
      -webkit-text-size-adjust: none;
    }
  }
  
  /* å¾®ä¿¡æµè§ˆå™¨ä¼˜åŒ– */
  @media screen and (max-width: 480px) {
    body.MicroMessenger mjx-container[display="true"] {
      font-size: 0.85em !important;
      margin: 0.5em 0 !important;
    }
  }
</style>
