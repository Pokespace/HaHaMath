<!-- 引入 MathJax 以支持 LaTeX 公式渲染 -->
<script>
  // 检测是否为移动设备
  var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true,
      processRefs: true,
      // 移动端特殊配置
      packages: {'[+]': ['base', 'ams', 'newcommand', 'configmacros']}
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      processHtmlClass: 'tex2jax_process',
      ignoreHtmlClass: 'tex2jax_ignore',
      renderActions: {
        findScript: [10, function (doc) {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/);
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
            const text = document.createTextNode('');
            node.parentNode.replaceChild(text, node);
            math.start = {node: text, delim: '', n: 0};
            math.end = {node: text, delim: '', n: 0};
            doc.math.push(math);
          }
        }, '']
      }
    },
    // 针对移动设备的特殊配置
    chtml: {
      scale: isMobile ? 0.9 : 1,
      minScale: 0.5,
      matchFontHeight: false,
      fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
    },
    svg: {
      scale: isMobile ? 0.9 : 1,
      minScale: 0.5,
      fontCache: 'local'
    },
    startup: {
      ready: function () {
        MathJax.startup.defaultReady();
        // 确保在移动设备上正确渲染
        if (isMobile) {
          document.addEventListener('DOMContentLoaded', function() {
            MathJax.typesetPromise();
          });
        }
      }
    }
  };
</script>

<!-- 多CDN备选方案，提高加载成功率 -->
<script>
  // 主CDN
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.id = 'MathJax-script';
  script.async = true;
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
  
  // 备用CDN
  script.onerror = function() {
    console.log('主CDN加载失败，尝试备用CDN');
    var backupScript = document.createElement('script');
    backupScript.type = 'text/javascript';
    backupScript.id = 'MathJax-script-backup';
    backupScript.async = true;
    backupScript.src = 'https://polyfill.io/v3/polyfill.min.js?features=es6';
    
    backupScript.onload = function() {
      var mathJaxScript = document.createElement('script');
      mathJaxScript.type = 'text/javascript';
      mathJaxScript.async = true;
      mathJaxScript.src = 'https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js';
      
      mathJaxScript.onerror = function() {
        console.log('备用CDN也加载失败，使用本地提示');
        document.body.insertAdjacentHTML('beforeend', 
          '<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px; border-radius: 5px;">' +
          '⚠️ 数学公式加载失败，请检查网络连接或刷新页面重试</div>');
      };
      
      document.head.appendChild(mathJaxScript);
    };
    
    document.head.appendChild(backupScript);
  };
  
  document.head.appendChild(script);
</script>

<!-- 移动端优化样式 -->
<style>
  @media screen and (max-width: 768px) {
    .MathJax {
      font-size: 0.9em !important;
    }
    
    .MathJax_Display {
      overflow-x: auto;
      overflow-y: hidden;
    }
    
    mjx-container[jax="CHTML"][display="true"] {
      overflow-x: auto;
      overflow-y: hidden;
      max-width: 100%;
    }
  }
  
  /* 确保公式在小屏幕上可滚动 */
  mjx-container {
    overflow-x: auto;
    overflow-y: hidden;
  }
</style>
