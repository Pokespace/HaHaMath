<!-- ç§»åŠ¨ç«¯æ•°å­¦å…¬å¼æ¸²æŸ“å¢å¼ºä¿®å¤è„šæœ¬ -->
<script>
(function() {
  'use strict';
  
  // å¢å¼ºçš„è®¾å¤‡æ£€æµ‹
  var userAgent = navigator.userAgent;
  var isAndroid = /Android/i.test(userAgent);
  var isIOS = /iPad|iPhone|iPod/.test(userAgent);
  var isOldAndroid = /Android [1-4]/i.test(userAgent);
  var isWeChat = /MicroMessenger/i.test(userAgent);
  var isQQ = /QQ\//i.test(userAgent);
  var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
  var isChrome = /Chrome/i.test(userAgent);
  var isSafari = /Safari/i.test(userAgent) && !isChrome;
  
  // ä¸ºç§»åŠ¨æµè§ˆå™¨æ·»åŠ æ ‡è¯†ç±»
  if (isMobile) {
    document.documentElement.classList.add('mobile-device');
    if (isAndroid) document.documentElement.classList.add('android-device');
    if (isIOS) document.documentElement.classList.add('ios-device');
    if (isWeChat) document.documentElement.classList.add('wechat-browser');
    if (isQQ) document.documentElement.classList.add('qq-browser');
  }
  
  // ç§»åŠ¨ç«¯æ•°å­¦å…¬å¼æ¸²æŸ“ç›‘æ§å’Œä¿®å¤
  function initMobileMathFix() {
    var mathRenderAttempts = 0;
    var maxRenderAttempts = 3;
    
    function checkAndFixMathRendering() {
      mathRenderAttempts++;
      
      if (typeof MathJax === 'undefined') {
        if (mathRenderAttempts < maxRenderAttempts) {
          setTimeout(checkAndFixMathRendering, 1000);
        } else {
          showMathJaxLoadingError();
        }
        return;
      }
      
      // ç­‰å¾…MathJaxå®Œå…¨åˆå§‹åŒ–
      if (MathJax.startup && MathJax.startup.promise) {
        MathJax.startup.promise.then(function() {
          applyMobileMathFixes();
        }).catch(function(err) {
          console.warn('MathJaxå¯åŠ¨å¤±è´¥:', err);
          if (mathRenderAttempts < maxRenderAttempts) {
            setTimeout(checkAndFixMathRendering, 2000);
          } else {
            showMathRenderingFallback();
          }
        });
      } else {
        // é™çº§å¤„ç†
        setTimeout(applyMobileMathFixes, 1000);
      }
    }
    
    function applyMobileMathFixes() {
      // è€ç‰ˆæœ¬å®‰å“ç‰¹æ®Šå¤„ç†
      if (isOldAndroid) {
        console.log('åº”ç”¨è€ç‰ˆæœ¬å®‰å“æ•°å­¦å…¬å¼ä¿®å¤');
        applyOldAndroidFixes();
      }
      
      // iOS Safariç‰¹æ®Šå¤„ç†
      if (isIOS && isSafari) {
        applyIOSSafariFixes();
      }
      
      // å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šå¤„ç†
      if (isWeChat) {
        applyWeChatFixes();
      }
      
      // é€šç”¨ç§»åŠ¨ç«¯ä¼˜åŒ–
      if (isMobile) {
        applyGeneralMobileFixes();
      }
      
      // å¼ºåˆ¶é‡æ–°æ¸²æŸ“
      if (MathJax.typesetPromise) {
        MathJax.typesetPromise().then(function() {
          console.log('ç§»åŠ¨ç«¯æ•°å­¦å…¬å¼ä¿®å¤å®Œæˆ');
          addTouchOptimizations();
        }).catch(function(err) {
          console.warn('æ•°å­¦å…¬å¼é‡æ–°æ¸²æŸ“å¤±è´¥:', err);
        });
      }
    }
    
    // è€ç‰ˆæœ¬å®‰å“ä¿®å¤
    function applyOldAndroidFixes() {
      // ç®€åŒ–å¤æ‚çš„LaTeXç¬¦å·
      var textNodes = [];
      var walker = document.createTreeWalker(
        document.body,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );
      
      var node;
      while (node = walker.nextNode()) {
        if (node.textContent.includes('\\')) {
          textNodes.push(node);
        }
      }
      
      textNodes.forEach(function(node) {
        var text = node.textContent;
        // ç®€åŒ–ä¸€äº›å¤æ‚ç¬¦å·
        text = text.replace(/\\mathbb\{([^}]+)\}/g, '$1');
        text = text.replace(/\\Rightarrow/g, '=>');
        text = text.replace(/\\complement_U/g, 'è¡¥é›†');
        text = text.replace(/\\cap/g, 'âˆ©');
        text = text.replace(/\\cup/g, 'âˆª');
        text = text.replace(/\\subseteq/g, 'âŠ†');
        text = text.replace(/\\subset/g, 'âŠ‚');
        text = text.replace(/\\mid/g, '|');
        text = text.replace(/\\cdot/g, 'Â·');
        text = text.replace(/\\times/g, 'Ã—');
        text = text.replace(/\\div/g, 'Ã·');
        
        if (text !== node.textContent) {
          node.textContent = text;
        }
      });
    }
    
    // iOS Safariä¿®å¤
    function applyIOSSafariFixes() {
      // æ·»åŠ iOSç‰¹å®šæ ·å¼
      var style = document.createElement('style');
      style.textContent = `
        mjx-container {
          -webkit-transform: translateZ(0);
          -webkit-backface-visibility: hidden;
        }
        
        mjx-container[display="true"] {
          -webkit-overflow-scrolling: touch;
          transform: translateZ(0);
        }
      `;
      document.head.appendChild(style);
    }
    
    // å¾®ä¿¡æµè§ˆå™¨ä¿®å¤
    function applyWeChatFixes() {
      document.body.classList.add('MicroMessenger');
      
      // å¾®ä¿¡æµè§ˆå™¨çš„ç‰¹æ®Šå­—ä½“è®¾ç½®
      var style = document.createElement('style');
      style.textContent = `
        .MicroMessenger mjx-container {
          font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif !important;
        }
        
        .MicroMessenger mjx-container[display="true"] {
          margin: 0.5em auto !important;
          max-width: 95% !important;
        }
      `;
      document.head.appendChild(style);
    }
    
    // é€šç”¨ç§»åŠ¨ç«¯ä¿®å¤
    function applyGeneralMobileFixes() {
      // æ·»åŠ é€šç”¨ç§»åŠ¨ç«¯æ ·å¼
      var style = document.createElement('style');
      style.textContent = `
        .mobile-device mjx-container {
          max-width: 100% !important;
          word-wrap: break-word !important;
        }
        
        .mobile-device mjx-container[display="true"] {
          overflow-x: auto !important;
          overflow-y: hidden !important;
          padding: 0.2em 0 !important;
          margin: 0.8em 0 !important;
        }
        
        .mobile-device mjx-container[display="false"] {
          display: inline !important;
          vertical-align: baseline !important;
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .mobile-device mjx-container[display="true"]::-webkit-scrollbar {
          height: 4px !important;
          background: rgba(0,0,0,0.1) !important;
        }
        
        .mobile-device mjx-container[display="true"]::-webkit-scrollbar-thumb {
          background: rgba(0,0,0,0.3) !important;
          border-radius: 2px !important;
        }
      `;
      document.head.appendChild(style);
    }
    
    // æ·»åŠ è§¦æ‘¸ä¼˜åŒ–
    function addTouchOptimizations() {
      if (!isMobile) return;
      
      var mathContainers = document.querySelectorAll('mjx-container[display="true"]');
      mathContainers.forEach(function(container) {
        container.addEventListener('touchstart', function() {
          container.style.webkitOverflowScrolling = 'touch';
        }, {passive: true});
        
        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        container.addEventListener('touchend', function(e) {
          e.preventDefault();
        });
      });
    }
    
    // æ˜¾ç¤ºMathJaxåŠ è½½é”™è¯¯
    function showMathJaxLoadingError() {
      var notice = document.createElement('div');
      notice.style.cssText = 'background: #f8d7da; border: 1px solid #f5c6cb; padding: 8px; margin: 10px 0; border-radius: 4px; color: #721c24; text-align: center; font-size: 14px;';
      notice.innerHTML = 'âŒ MathJaxåŠ è½½å¤±è´¥ï¼Œæ•°å­¦å…¬å¼æ— æ³•æ˜¾ç¤º';
      
      var container = document.getElementById('main-content') || document.body;
      container.insertBefore(notice, container.firstChild);
    }
    
    // æ˜¾ç¤ºæ¸²æŸ“é™çº§æç¤º
    function showMathRenderingFallback() {
      var mathElements = document.querySelectorAll('script[type*="math"], .math, [class*="math"]');
      if (mathElements.length > 0) {
        var notice = document.createElement('div');
        notice.style.cssText = 'background: #d1ecf1; border: 1px solid #bee5eb; padding: 8px; margin: 10px 0; border-radius: 4px; color: #0c5460; text-align: center; font-size: 14px;';
        notice.innerHTML = 'ğŸ“± ç§»åŠ¨ç«¯æ•°å­¦å…¬å¼æ¸²æŸ“ä¼˜åŒ–ä¸­ï¼Œå¦‚æœ‰æ˜¾ç¤ºé—®é¢˜è¯·åˆ·æ–°é¡µé¢';
        
        var container = document.getElementById('main-content') || document.body;
        container.insertBefore(notice, container.firstChild);
        
        // 5ç§’åç§»é™¤æç¤º
        setTimeout(function() {
          if (notice.parentNode) {
            notice.parentNode.removeChild(notice);
          }
        }, 5000);
      }
    }
    
    // å¼€å§‹æ‰§è¡Œä¿®å¤
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAndFixMathRendering);
    } else {
      setTimeout(checkAndFixMathRendering, 100);
    }
  }
  
  // è§†å£å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ï¼ˆå¤„ç†æ¨ªç«–å±åˆ‡æ¢ï¼‰
  function handleOrientationChange() {
    if (!isMobile) return;
    
    var orientationChangeHandler = function() {
      setTimeout(function() {
        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
          MathJax.typesetPromise().then(function() {
            console.log('æ¨ªç«–å±åˆ‡æ¢åæ•°å­¦å…¬å¼é‡æ–°æ¸²æŸ“å®Œæˆ');
          });
        }
      }, 500);
    };
    
    window.addEventListener('orientationchange', orientationChangeHandler);
    window.addEventListener('resize', function() {
      clearTimeout(window.resizeTimeout);
      window.resizeTimeout = setTimeout(orientationChangeHandler, 300);
    });
  }
  
  // åˆå§‹åŒ–æ‰€æœ‰ä¿®å¤
  initMobileMathFix();
  handleOrientationChange();
  
})();
</script>

<!-- ç§»åŠ¨ç«¯å¢å¼ºCSSæ ·å¼ -->
<style>
  /* åŸºç¡€ç§»åŠ¨ç«¯ä¼˜åŒ– */
  .mobile-device {
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
  }
  
  /* å®‰å“è®¾å¤‡ç‰¹æ®Šå¤„ç† */
  .android-device mjx-container {
    font-family: "Droid Sans", "Microsoft YaHei", sans-serif !important;
  }
  
  .android-device mjx-container[display="true"] {
    background: rgba(0,0,0,0.01) !important; /* å¼ºåˆ¶ç¡¬ä»¶åŠ é€Ÿ */
  }
  
  /* iOSè®¾å¤‡ç‰¹æ®Šå¤„ç† */
  .ios-device mjx-container {
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }
  
  .ios-device mjx-container[display="true"] {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
  }
  
  /* å¾®ä¿¡æµè§ˆå™¨ä¼˜åŒ– */
  .wechat-browser mjx-container[display="true"] {
    margin: 0.5em auto !important;
    font-size: 0.9em !important;
  }
  
  /* QQæµè§ˆå™¨ä¼˜åŒ– */
  .qq-browser mjx-container {
    font-weight: normal !important;
  }
  
  /* å“åº”å¼æ–­ç‚¹ä¼˜åŒ– */
  @media screen and (max-width: 414px) {
    .mobile-device mjx-container {
      font-size: 0.85em !important;
    }
  }
  
  @media screen and (max-width: 375px) {
    .mobile-device mjx-container {
      font-size: 0.8em !important;
    }
    
    .mobile-device mjx-container[display="true"] {
      margin: 0.6em 0 !important;
    }
  }
  
  @media screen and (max-width: 320px) {
    .mobile-device mjx-container {
      font-size: 0.75em !important;
    }
  }
  
  /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
  @media screen and (orientation: landscape) and (max-height: 500px) {
    .mobile-device mjx-container[display="true"] {
      margin: 0.3em 0 !important;
      font-size: 0.9em !important;
    }
  }
  
  /* é«˜DPIå±å¹•ä¼˜åŒ– */
  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .mobile-device mjx-container {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  }
</style> 